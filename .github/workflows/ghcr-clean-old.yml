name: Cleanup Old Container Images

on:
  schedule:
    - cron: '0 2 * * 0'  # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹
  workflow_dispatch:
    inputs:
      days_old:
        description: 'åˆ é™¤è¶…è¿‡å¤šå°‘å¤©çš„é•œåƒ'
        required: true
        default: '30'
        type: string
      keep_minimum:
        description: 'è‡³å°‘ä¿ç•™æœ€è¿‘å¤šå°‘ä¸ªé•œåƒ'
        required: false
        default: '10'
        type: string
      package_name:
        description: 'è¦æ¸…ç†çš„åŒ…åç§°'
        required: true
        default: 'pass-craft'
        type: string
      dry_run:
        description: 'ä»…æ˜¾ç¤ºå°†è¦åˆ é™¤çš„é•œåƒï¼Œä¸å®é™…åˆ é™¤'
        required: false
        default: false
        type: boolean

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        run: |
          # ç¡®ä¿ GitHub CLI å·²å®‰è£…
          command -v gh >/dev/null 2>&1 || {
            echo "GitHub CLI å·²å®‰è£…"
          }

      - name: Cleanup container images
        run: |
          DAYS_OLD=${DAYS_OLD:-30}
          KEEP_MINIMUM=${KEEP_MINIMUM:-10}
          PACKAGE_NAME=${PACKAGE_NAME:-pass-craft}
          DRY_RUN=${DRY_RUN:-false}
          
          echo "ğŸ—‘ï¸ å®¹å™¨é•œåƒæ¸…ç†é…ç½®:"
          echo "  æ¨¡å¼: $([ "$DRY_RUN" = "true" ] && echo "ğŸ” é¢„è§ˆæ¨¡å¼" || echo "ğŸ—‘ï¸ åˆ é™¤æ¨¡å¼")"
          echo "  æ—¶é—´é˜ˆå€¼: $DAYS_OLD å¤©"
          echo "  æœ€å°‘ä¿ç•™: $KEEP_MINIMUM ä¸ªé•œåƒ"
          echo "  åŒ…åç§°: $PACKAGE_NAME"
          echo "  ä»“åº“: $GITHUB_REPOSITORY"

          # è·å–æ‰€æœ‰å®¹å™¨é•œåƒç‰ˆæœ¬
          echo "ğŸ“¦ è·å–å®¹å™¨é•œåƒåˆ—è¡¨..."
          package_versions=$(gh api repos/$GITHUB_REPOSITORY/packages/container/$PACKAGE_NAME/versions \
            --jq 'sort_by(.updated_at) | reverse')
          
          total_count=$(echo "$package_versions" | jq length)
          echo "ğŸ“Š æ€»é•œåƒæ•°é‡: $total_count"

          if [ $total_count -eq 0 ]; then
            echo "âœ… æ²¡æœ‰æ‰¾åˆ°å®¹å™¨é•œåƒã€‚"
            exit 0
          fi

          # è®¡ç®—æˆªæ­¢æ—¶é—´ï¼ˆå½“å‰æ—¶é—´å‡å»å¤©æ•°ï¼‰
          cutoff_date=$(date -d "$DAYS_OLD days ago" -Iseconds | sed 's/+/%2B/')
          echo "â° æˆªæ­¢æ—¶é—´: $(date -d "$DAYS_OLD days ago" '+%Y-%m-%d %H:%M:%S')"

          # è·å–éœ€è¦åˆ é™¤çš„é•œåƒIDï¼ˆæ’é™¤æœ€æ–°çš„ KEEP_MINIMUM ä¸ªï¼Œä¸”è¶…è¿‡å¤©æ•°ï¼‰
          delete_ids=$(echo "$package_versions" | \
            jq -r ".[$KEEP_MINIMUM:] | .[] | select(.updated_at < \"$cutoff_date\") | .id")

          if [ -z "$delete_ids" ]; then
            echo "âœ… æ²¡æœ‰æ‰¾åˆ°éœ€è¦åˆ é™¤çš„é•œåƒã€‚"
            echo "ğŸ’¡ å¯èƒ½åŸå› ï¼š"
            echo "   - é•œåƒæ•°é‡å°‘äºæœ€å°‘ä¿ç•™æ•° ($KEEP_MINIMUM)"
            echo "   - æ‰€æœ‰é•œåƒéƒ½åœ¨ $DAYS_OLD å¤©å†…æ›´æ–°"
            exit 0
          fi

          count=$(echo "$delete_ids" | wc -l)
          echo "æ‰¾åˆ° $count ä¸ªéœ€è¦å¤„ç†çš„é•œåƒ:"
          echo "$delete_ids" | head -5
          if [ $count -gt 5 ]; then
            echo "... è¿˜æœ‰ $((count - 5)) ä¸ªé•œåƒ"
          fi

          # æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
          echo "ğŸ“‹ å°†è¦åˆ é™¤çš„é•œåƒè¯¦æƒ…:"
          echo "$package_versions" | jq -r ".[] | select(.id | IN($(echo "$delete_ids" | paste -sd, -))) | \"  - ID: \(.id), æ›´æ–°: \(.updated_at), æ ‡ç­¾: \(.metadata.container.tags | join(\", \"))\""

          if [ "$DRY_RUN" = "true" ]; then
            echo "ğŸ” é¢„è§ˆæ¨¡å¼ï¼šä»¥ä¸Šé•œåƒå°†è¢«åˆ é™¤ï¼ˆå®é™…æœªæ‰§è¡Œåˆ é™¤æ“ä½œï¼‰"
            echo "ğŸ“ˆ æ¸…ç†åå‰©ä½™é•œåƒæ•°: $((total_count - count))"
          else
            echo "ğŸš€ å¼€å§‹åˆ é™¤é•œåƒ..."
            deleted_count=0
            failed_count=0
            
            while IFS= read -r version_id; do
              if [ -n "$version_id" ]; then
                echo "ğŸ—‘ï¸  åˆ é™¤é•œåƒç‰ˆæœ¬: $version_id"
                if gh api \
                  repos/$GITHUB_REPOSITORY/packages/container/$PACKAGE_NAME/versions/$version_id \
                  --method DELETE --silent; then
                  echo "âœ… æˆåŠŸåˆ é™¤: $version_id"
                  deleted_count=$((deleted_count + 1))
                else
                  echo "âŒ åˆ é™¤å¤±è´¥: $version_id"
                  failed_count=$((failed_count + 1))
                fi
                # æ·»åŠ å»¶è¿Ÿé¿å… API é™åˆ¶
                sleep 1
              fi
            done <<< "$delete_ids"
            
            echo "ğŸ‰ æ¸…ç†å®Œæˆï¼"
            echo "ğŸ“Š ç»Ÿè®¡: æˆåŠŸ $deleted_count, å¤±è´¥ $failed_count, æ€»è®¡ $count"
            echo "ğŸ“ˆ å‰©ä½™é•œåƒæ•°: $((total_count - deleted_count))"
            
            if [ $failed_count -gt 0 ]; then
              echo "âš ï¸  æœ‰ $failed_count ä¸ªé•œåƒåˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™å’Œç½‘ç»œè¿æ¥"
              exit 1
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DAYS_OLD: ${{ inputs.days_old }}
          KEEP_MINIMUM: ${{ inputs.keep_minimum }}
          # PACKAGE_NAME: ${{ inputs.package_name }}
          PACKAGE_NAME: ${{ github.event.repository.name }}
          DRY_RUN: ${{ inputs.dry_run }}
          GITHUB_REPOSITORY: ${{ github.repository }}