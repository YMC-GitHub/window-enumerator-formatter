name: Cleanup Old Workflow Runs Daily

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œ
  workflow_dispatch:
    inputs:
      days_old:
        description: 'åˆ é™¤è¶…è¿‡å¤šå°‘å¤©çš„è®°å½•'
        required: true
        default: '30'
        type: string
      keep_minimum:
        description: 'è‡³å°‘ä¿ç•™æœ€è¿‘å¤šå°‘æ¡è®°å½•ï¼ˆå³ä½¿è¶…è¿‡å¤©æ•°ï¼‰'
        required: false
        default: '10'
        type: string
      dry_run:
        description: 'ä»…æ˜¾ç¤ºå°†è¦åˆ é™¤çš„è®°å½•ï¼Œä¸å®é™…åˆ é™¤'
        required: false
        default: false
        type: boolean

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    
    steps:
      - name: Cleanup workflow runs
        run: |
          DAYS_OLD=${DAYS_OLD:-30}
          KEEP_MINIMUM=${KEEP_MINIMUM:-10}
          DRY_RUN=${DRY_RUN:-false}
          
          echo "ğŸ—“ï¸ æ¸…ç†é…ç½®:"
          echo "  æ¨¡å¼: $([ "$DRY_RUN" = "true" ] && echo "ğŸ” é¢„è§ˆæ¨¡å¼" || echo "ğŸ—‘ï¸ åˆ é™¤æ¨¡å¼")"
          echo "  æ—¶é—´é˜ˆå€¼: $DAYS_OLD å¤©"
          echo "  æœ€å°‘ä¿ç•™: $KEEP_MINIMUM æ¡è®°å½•"
          echo "  ä»“åº“: $GITHUB_REPOSITORY"

          # è·å–æ‰€æœ‰è¿è¡Œè®°å½•ç”¨äºç»Ÿè®¡
          all_runs_json=$(gh run list --repo $GITHUB_REPOSITORY \
            --json databaseId,createdAt,workflowName,status,conclusion \
            --limit 500)

          total_count=$(echo "$all_runs_json" | jq length)
          echo "ğŸ“Š æ€»è¿è¡Œè®°å½•æ•°: $total_count"

          # è·å–éœ€è¦åˆ é™¤çš„è¿è¡Œè®°å½•ï¼ˆæ’é™¤æœ€æ–°çš„ KEEP_MINIMUM æ¡ï¼‰
          run_ids=$(echo "$all_runs_json" | \
            jq "sort_by(.createdAt) | reverse | .[$KEEP_MINIMUM:] | .[] | select((.createdAt | fromdateiso8601) < (now - ($DAYS_OLD|tonumber)*24*60*60)) | .databaseId")

          if [ -z "$run_ids" ]; then
            echo "âœ… æ²¡æœ‰æ‰¾åˆ°éœ€è¦åˆ é™¤çš„è¿è¡Œè®°å½•ã€‚"
            echo "ğŸ’¡ å¯èƒ½åŸå› ï¼š"
            echo "   - è®°å½•æ•°é‡å°‘äºæœ€å°‘ä¿ç•™æ•° ($KEEP_MINIMUM)"
            echo "   - æ‰€æœ‰è®°å½•éƒ½åœ¨ $DAYS_OLD å¤©å†…"
            exit 0
          fi
          
          count=$(echo "$run_ids" | wc -l)
          echo "æ‰¾åˆ° $count æ¡éœ€è¦å¤„ç†çš„è¿è¡Œè®°å½•:"
          echo "$run_ids" | head -5
          if [ $count -gt 5 ]; then
            echo "... è¿˜æœ‰ $((count - 5)) æ¡è®°å½•"
          fi
          
          if [ "$DRY_RUN" = "true" ]; then
            echo "ğŸ” é¢„è§ˆæ¨¡å¼ï¼šä»¥ä¸Šè¿è¡Œè®°å½•å°†è¢«åˆ é™¤ï¼ˆå®é™…æœªæ‰§è¡Œåˆ é™¤æ“ä½œï¼‰"
            echo "ğŸ“ˆ æ¸…ç†åå‰©ä½™è®°å½•æ•°: $((total_count - count))"
          else
            echo "ğŸš€ å¼€å§‹åˆ é™¤è¿è¡Œè®°å½•..."
            deleted_count=0
            while IFS= read -r run_id; do
              if [ -n "$run_id" ]; then
                echo "ğŸ—‘ï¸  åˆ é™¤è¿è¡Œè®°å½•: $run_id"
                if gh run delete "$run_id" --repo $GITHUB_REPOSITORY; then
                  echo "âœ… æˆåŠŸåˆ é™¤: $run_id"
                  deleted_count=$((deleted_count + 1))
                else
                  echo "âŒ åˆ é™¤å¤±è´¥: $run_id"
                fi
                sleep 0.5
              fi
            done <<< "$run_ids"
            echo "ğŸ‰ æ¸…ç†å®Œæˆï¼"
            echo "ğŸ“Š ç»Ÿè®¡: æˆåŠŸåˆ é™¤ $deleted_count/$count æ¡è¿è¡Œè®°å½•"
            echo "ğŸ“ˆ å‰©ä½™è®°å½•æ•°: $((total_count - deleted_count))"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DAYS_OLD: ${{ inputs.days_old }}
          KEEP_MINIMUM: ${{ inputs.keep_minimum }}
          DRY_RUN: ${{ inputs.dry_run }}
          GITHUB_REPOSITORY: ${{ github.repository }}