name: Publish to crates.io

on:
  # push:
  #   tags:
  #     - 'v*'  # æ¨é€ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'Version tag (æ ¼å¼: v0.1.0)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (åªæ£€æŸ¥ä¸å‘å¸ƒ)'
        required: false
        default: false
        type: boolean
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•'
        required: false
        default: false
        type: boolean

env:
  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
  CRATE_NAME: window-enumerator

jobs:
  validate:
    name: Validate Package
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Check clippy
        run: cargo clippy --all-features -- -D warnings

      - name: Run tests
        run: cargo test --all-features

      - name: Check documentation
        run: cargo doc --no-deps --all-features

      - name: Validate package
        run: cargo package --allow-dirty

      - name: Check version consistency
        id: version_check
        run: |
          # ä» Cargo.toml è·å–ç‰ˆæœ¬
          CARGO_VERSION=$(grep '^version' Cargo.toml | head -1 | cut -d '"' -f2)
          
          # ä»æ ‡ç­¾è·å–ç‰ˆæœ¬
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG_VERSION="${{ inputs.version }}"
          else
            TAG_VERSION="${GITHUB_REF#refs/tags/}"
          fi
          
          # ç§»é™¤æ ‡ç­¾çš„ v å‰ç¼€
          TAG_VERSION=${TAG_VERSION#v}
          
          echo "Cargo.toml version: $CARGO_VERSION"
          echo "Tag version: $TAG_VERSION"
          
          if [ "$CARGO_VERSION" != "$TAG_VERSION" ]; then
            echo "âŒ ç‰ˆæœ¬ä¸åŒ¹é…: Cargo.toml ($CARGO_VERSION) ä¸æ ‡ç­¾ ($TAG_VERSION) ä¸ä¸€è‡´"
            exit 1
          fi
          
          echo "âœ… ç‰ˆæœ¬æ£€æŸ¥é€šè¿‡"
          echo "package_version=$CARGO_VERSION" >> $GITHUB_OUTPUT

      - name: Validation report
        run: |
          echo "âœ… åŒ…éªŒè¯å®Œæˆ"
          echo "ğŸ“¦ åŒ…å: ${{ env.CRATE_NAME }}"
          echo "ğŸ·ï¸ ç‰ˆæœ¬: ${{ steps.version_check.outputs.package_version }}"
          echo "ğŸ”§ çŠ¶æ€: é€šè¿‡æ‰€æœ‰æ£€æŸ¥"

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: validate
    if: ${{ !inputs.skip_tests }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build with all features
        run: cargo build --release --all-features

      - name: Run tests on Windows
        run: cargo test --release --all-features

      - name: Verify library build
        run: |
          # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†åº“æ–‡ä»¶
          if (Test-Path "target\release\window_enumerator.dll") {
            echo "âœ… åŠ¨æ€åº“æ„å»ºæˆåŠŸ"
            Get-Item "target\release\window_enumerator.dll" | % { 
              echo "æ–‡ä»¶: $($_.Name), å¤§å°: $([math]::Round($_.Length/1KB, 2)) KB" 
            }
          }
          if (Test-Path "target\release\window_enumerator.lib") {
            echo "âœ… é™æ€åº“æ„å»ºæˆåŠŸ"
          }
          if (Test-Path "target\release\window_enumerator.rlib") {
            echo "âœ… Rust åº“æ„å»ºæˆåŠŸ"
          }

      - name: Windows build report
        run: |
          echo "âœ… Windows æ„å»ºæµ‹è¯•å®Œæˆ"
          echo "ğŸ¯ ç›®æ ‡å¹³å°: x86_64-pc-windows-msvc"
          echo "ğŸ”§ ç‰¹æ€§: å…¨éƒ¨å¯ç”¨"
          echo "ğŸ§ª æµ‹è¯•: é€šè¿‡"

  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: 
      - validate
      - build-windows
    if: >
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch' && !inputs.dry_run)
    environment: cargo-publish
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Set up cargo registry token
        run: |
          if [ -n "${{ secrets.CARGO_REGISTRY_TOKEN }}" ]; then
            echo "ğŸ”‘ è®¾ç½® cargo registry token"
            cargo login ${{ secrets.CARGO_REGISTRY_TOKEN }}
          else
            echo "âŒ æœªæ‰¾åˆ° CARGO_REGISTRY_TOKEN secret"
            exit 1
          fi

      - name: Publish to crates.io
        run: cargo publish --verbose
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Wait for crates.io index update
        run: |
          echo "â³ ç­‰å¾… crates.io ç´¢å¼•æ›´æ–°..."
          sleep 30

      - name: Verify publication
        id: verify
        run: |
          # ä» Cargo.toml è·å–åŒ…åå’Œç‰ˆæœ¬
          PACKAGE_NAME=$(grep '^name' Cargo.toml | head -1 | cut -d '"' -f2)
          PACKAGE_VERSION=$(grep '^version' Cargo.toml | head -1 | cut -d '"' -f2)
          
          echo "æ£€æŸ¥åŒ…: $PACKAGE_NAME, ç‰ˆæœ¬: $PACKAGE_VERSION"
          
          # å°è¯•ä» crates.io è·å–åŒ…ä¿¡æ¯
          if curl -s "https://crates.io/api/v1/crates/$PACKAGE_NAME" | jq -e ".crate.max_version == \"$PACKAGE_VERSION\"" > /dev/null; then
            echo "âœ… å‘å¸ƒéªŒè¯æˆåŠŸ: $PACKAGE_NAME v$PACKAGE_VERSION å·²åœ¨ crates.io ä¸Šå¯ç”¨"
            echo "published=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ å‘å¸ƒéªŒè¯ä¸­ï¼Œå¯èƒ½éœ€è¦æ›´å¤šæ—¶é—´..."
            echo "published=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish completion report
        run: |
          echo "ğŸš€ å‘å¸ƒåˆ° crates.io å®Œæˆ!"
          echo "=================================="
          echo "ğŸ“¦ åŒ…å: ${{ env.CRATE_NAME }}"
          echo "ğŸ·ï¸ ç‰ˆæœ¬: ${{ needs.validate.outputs.package_version }}"
          echo "ğŸ”— é“¾æ¥: https://crates.io/crates/${{ env.CRATE_NAME }}/${{ needs.validate.outputs.package_version }}"
          echo "ğŸ“š æ–‡æ¡£: https://docs.rs/${{ env.CRATE_NAME }}/${{ needs.validate.outputs.package_version }}"

  dry-run:
    name: Dry Run
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Dry run publish
        run: cargo publish --dry-run --verbose

      - name: Dry run completion
        run: |
          echo "âœ… Dry run å®Œæˆ"
          echo "ğŸ“¦ åŒ…éªŒè¯é€šè¿‡ï¼Œå¯ä»¥å‘å¸ƒ"
          echo "ğŸ” æ£€æŸ¥é¡¹ç›®:"
          echo "  - æ ¼å¼æ£€æŸ¥: âœ…"
          echo "  - Clippy æ£€æŸ¥: âœ…" 
          echo "  - æµ‹è¯•é€šè¿‡: âœ…"
          echo "  - æ–‡æ¡£ç”Ÿæˆ: âœ…"
          echo "  - åŒ…éªŒè¯: âœ…"
          echo "  - Dry run: âœ…"
          echo ""
          echo "ğŸš€ ä¸‹ä¸€æ­¥: è¿è¡Œå·¥ä½œæµæ—¶ä¸ä½¿ç”¨ --dry-run å‚æ•°æ¥å®é™…å‘å¸ƒ"

  post-publish:
    name: Post Publish
    runs-on: ubuntu-latest
    needs: publish
    if: success()
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version info
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          
          PACKAGE_NAME=$(grep '^name' Cargo.toml | head -1 | cut -d '"' -f2)
          PACKAGE_VERSION=$(grep '^version' Cargo.toml | head -1 | cut -d '"' -f2)
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT

      - name: Generate changelog
        run: |
          if [ -f "./scripts/generate-changelog.sh" ]; then
            chmod +x ./scripts/generate-changelog.sh
            ./scripts/generate-changelog.sh --version ${{ steps.version.outputs.version }}
          else
            echo "âš ï¸  Changelog ç”Ÿæˆè„šæœ¬æœªæ‰¾åˆ°ï¼Œè·³è¿‡"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.package_name }} v${{ steps.version.outputs.package_version }}
          body: |
            # ${{ steps.version.outputs.package_name }} v${{ steps.version.outputs.package_version }}
            
            ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒï¼
            
            ## ğŸ“¦ Crate ä¿¡æ¯
            - **åŒ…å**: `${{ steps.version.outputs.package_name }}`
            - **ç‰ˆæœ¬**: `${{ steps.version.outputs.package_version }}`
            - **æ–‡æ¡£**: https://docs.rs/${{ steps.version.outputs.package_name }}/${{ steps.version.outputs.package_version }}/
            - **Crates.io**: https://crates.io/crates/${{ steps.version.outputs.package_name }}/${{ steps.version.outputs.package_version }}
            
            ## ğŸ”§ ä½¿ç”¨æ–¹å¼
            ```toml
            [dependencies]
            ${{ steps.version.outputs.package_name }} = "${{ steps.version.outputs.package_version }}"
            ```
            
            ## ğŸ“š ç‰¹æ€§
            - Windows çª—å£æšä¸¾å’Œè¿‡æ»¤
            - å¤šæ¡ä»¶æ’åº (PID, æ ‡é¢˜, ä½ç½®)
            - ç´¢å¼•é€‰æ‹©åŠŸèƒ½
            - Windows API å®‰å…¨å°è£…
            
            ## ğŸ·ï¸ ç‰ˆæœ¬æ ‡ç­¾
            `${{ steps.version.outputs.version }}`
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-alpha') || contains(steps.version.outputs.version, '-beta') || contains(steps.version.outputs.version, '-rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Success notification
        run: |
          echo "ğŸš€ å‘å¸ƒæµç¨‹å®Œæˆ!"
          echo "================"
          echo "ğŸ“¦ åŒ…: ${{ steps.version.outputs.package_name }}"
          echo "ğŸ·ï¸ ç‰ˆæœ¬: v${{ steps.version.outputs.package_version }}"
          echo "ğŸ“š æ–‡æ¡£: https://docs.rs/${{ steps.version.outputs.package_name }}/${{ steps.version.outputs.package_version }}/"
          echo "ğŸ“‹ Crates.io: https://crates.io/crates/${{ steps.version.outputs.package_name }}/${{ steps.version.outputs.package_version }}"
          echo "ğŸ”– GitHub Release: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"